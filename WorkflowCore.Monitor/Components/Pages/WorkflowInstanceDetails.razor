@page "/workflows/instances/{Id}"
@using System.Text.Json
@implements IDisposable

@inject Services.WorkflowInstanceService WorkflowInstanceService
@inject WorkflowMonitorService WorkflowMonitorService

<MudGrid>
    <MudItem xs="12" sm="4" md="3">
        <MudPaper Class="pa-4" Style="height: calc(100vh - 100px); overflow-y: auto;">
            <MudTreeView T=ExecutionPointer Hover="true" @bind-SelectedValue="_selectedPointer" SelectionMode="SelectionMode.ToggleSelection">
                <MudTreeViewItem Text="@_instance.Display()" Expanded Icon="@GetWorkflowStatusIcon(_instance.Status)" IconColor="@GetWorkflowStatusColor(_instance.Status)">
                    @foreach (var step in _instance.ExecutionPointers)
                    {
                        <MudTreeViewItem Value="@step">
                            <Content>
                                <MudTooltip Text="@step.Status.ToString()">
                                    <MudIcon Icon="@GetStepStatusIcon(step.Status)" Color="@GetStepStatusColor(step.Status)" Class="ml-0 mr-2" />
                                </MudTooltip>
                                <MudText>@step.StepId - @(step.StepName ?? "Anonymous step")</MudText>
                            </Content>
                        </MudTreeViewItem>
                    }
                </MudTreeViewItem>
            </MudTreeView>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="8" md="9">
        <MudPaper Class="pa-4" Style="height: calc(100vh - 100px); overflow-y: auto;">
            <MudToolBar Dense="true" Class="mb-4">
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Error" 
                           StartIcon="@Icons.Material.Filled.Stop"
                           OnClick="Stop"
                           Disabled="@_instanceIsCompleted">
                    Stop
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Warning"
                           StartIcon="@Icons.Material.Filled.Pause"
                           OnClick="Suspend"
                           Class="ml-4"
                           Disabled="@_instanceIsCompleted">
                    Suspend
                </MudButton>
            </MudToolBar>
            
            @if (_selectedPointer is not null)
            {
                <MudText Typo="Typo.h6" Class="mb-4">Execution Pointer Details</MudText>
                <div style="background-color: #1e1e1e; padding: 16px; border-radius: 4px; overflow-x: auto;">
                    <pre style="margin: 0;"><code class="language-json" style="color: #d4d4d4; font-family: 'Consolas', 'Courier New', monospace;">@GetJsonDetails(_selectedPointer)</code></pre>
                </div>
            }
            else if (_instance is not null)
            {
                <MudText Typo="Typo.h6" Class="mb-4">Workflow Instance Details</MudText>
                <div style="background-color: #1e1e1e; padding: 16px; border-radius: 4px; overflow-x: auto;">
                    <pre style="margin: 0;"><code class="language-json" style="color: #d4d4d4; font-family: 'Consolas', 'Courier New', monospace;">@GetJsonDetails(new SimpleWorkflowInstance(_instance))</code></pre>
                </div>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {

    [Parameter]
    public string Id { get; set; } = string.Empty;

    WorkflowInstance _instance = null!;
    ExecutionPointer? _selectedPointer;

    System.Timers.Timer _timer = new(2_000);

    private bool _instanceIsCompleted => _instance.CompleteTime != null;

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();

        _timer.Elapsed += async (sender, e) =>
        {
            await RefreshData();


            if (_instanceIsCompleted)
            {
                _timer.Stop();
            }

            await InvokeAsync(StateHasChanged);
        };

        _timer.Start();
    }

    private async Task RefreshData()
    {
        var instance = await WorkflowMonitorService.GetWorkflowInstanceAsync(Id);
        _instance = instance ?? throw new InvalidOperationException($"Workflow instance '{Id}' not found.");
    }

    private async Task Stop()
    {
        var stopped = await WorkflowInstanceService.StopAsync(_instance);

        if (stopped)
            await RefreshData();
    }

    private async Task Suspend()
    {
        var suspended = await WorkflowInstanceService.StopAsync(_instance);

        if (suspended)
            await RefreshData();
    }

    private string GetJsonDetails(object? data)
    {
        return JsonSerializer.Serialize(data, AspNetCore.Json.WorkflowJsonSerializerOptions.Indented);
    }

    private string GetWorkflowStatusIcon(WorkflowStatus status)
    {
        return status switch
        {
            WorkflowStatus.Complete => Icons.Material.Filled.CheckCircle,
            WorkflowStatus.Runnable => Icons.Material.Filled.PlayCircle,
            WorkflowStatus.Suspended => Icons.Material.Filled.PauseCircle,
            WorkflowStatus.Terminated => Icons.Material.Filled.Cancel,
            _ => Icons.Material.Filled.HelpOutline
        };
    }

    private Color GetWorkflowStatusColor(WorkflowStatus status)
    {
        return status switch
        {
            WorkflowStatus.Runnable => Color.Info,
            WorkflowStatus.Complete => Color.Success,
            WorkflowStatus.Suspended => Color.Dark,
            WorkflowStatus.Terminated => Color.Error,
            _ => Color.Default
        };
    }

    private string GetStepStatusIcon(PointerStatus status)
    {
        return status switch
        {
            PointerStatus.Complete => Icons.Material.Filled.CheckCircle,
            PointerStatus.Running => Icons.Material.Filled.PlayCircle,
            PointerStatus.WaitingForEvent => Icons.Material.Filled.Schedule,
            PointerStatus.Sleeping => Icons.Material.Filled.Bedtime,
            PointerStatus.Failed => Icons.Material.Filled.Error,
            PointerStatus.Cancelled => Icons.Material.Filled.Cancel,
            PointerStatus.Compensated => Icons.Material.Filled.Undo,
            _ => Icons.Material.Filled.HelpOutline
        };
    }

    private Color GetStepStatusColor(PointerStatus status)
    {
        return status switch
        {
            PointerStatus.Complete => Color.Success,
            PointerStatus.Running => Color.Info,
            PointerStatus.WaitingForEvent => Color.Warning,
            PointerStatus.Sleeping => Color.Default,
            PointerStatus.Failed => Color.Error,
            PointerStatus.Cancelled => Color.Dark,
            PointerStatus.Compensated => Color.Secondary,
            _ => Color.Default
        };
    }

    public void Dispose()
    {
        _timer.Stop();
        _timer.Dispose();
    }

    public class SimpleWorkflowInstance
    {
        public SimpleWorkflowInstance(WorkflowInstance instance)
        {
            Id = instance.Id;
            Reference = instance.Reference;
            WorkflowDefinitionId = instance.WorkflowDefinitionId;
            Version = instance.Version;
            Description = instance.Description;
            CompleteTime = instance.CompleteTime;
            CreateTime = instance.CreateTime;
            Data = instance.Data;
            NextExecution = instance.NextExecution;
            Status = instance.Status;
        }

        public string Id { get; }
        public string Reference { get; }
        public string WorkflowDefinitionId { get; }
        public int Version { get; }
        public string Description { get; }
        public DateTime CreateTime { get; }
        public DateTime? CompleteTime { get; }
        public object? Data { get; }
        public long? NextExecution { get; }
        public WorkflowStatus Status { get; }
    }
}
