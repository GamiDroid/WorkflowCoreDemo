@page "/workflows"

@inject WorkflowMonitorService WorkflowMonitorService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Workflows</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Workflows</MudText>

<MudDataGrid Items="@_workflowDefinitions">
    <Columns>
        <PropertyColumn Property="x => x.Id" Title="#" />
        <PropertyColumn Property="x => x.Version" />
        <PropertyColumn Property="x => x.Description" />
        <PropertyColumn Property="x => x.Steps.Count" Title="Steps" />
        <TemplateColumn>
            <CellTemplate>
                <MudStack Row>
                    <MudButton OnClick="() => Start(context.Item)" Variant="Variant.Filled" Color="Color.Secondary">Start</MudButton>
                    <MudIconButton Href="@($"workflows/{context.Item.Id}")" Icon="@Icons.Material.Filled.MoreVert" />
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>

@code {

    List<WorkflowDefinition>? _workflowDefinitions;

    protected override void OnInitialized()
    {
        _workflowDefinitions = WorkflowMonitorService.GetRegisteredWorkflows().ToList();
    }

    private async Task Start(WorkflowDefinition def)
    {
        object? obj = null;

        if (def.Id == "StepsProgressWorkflow" && def.Version == 1)
        {
            var options = new DialogOptions { CloseOnEscapeKey = true };

            var wData = new Monitor.Workflows.StepsProgress();
            var parameters = new DialogParameters
            {
                ["Arguments"] = wData
            };

            var dRef = await DialogService.ShowAsync<WorkflowArgsDialog>("Arguments", parameters, options);
            var dResult = await dRef.Result;

            if (dResult!.Canceled)
            {
                return;
            }

            obj = dResult.Data;
        }

        var workflowId =
            await WorkflowMonitorService.StartWorkflowAsync(def.Id, def.Version, obj);
        Snackbar.Add($"Worflow {WorkflowUiHelper.WorkflowInstanceDisplay(def.Id, def.Version, workflowId)} started.", Severity.Success);
    }
}
